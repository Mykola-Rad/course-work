@model IMS.ViewModels.CounterpartyDetailsViewModel
@using IMS.Models 

@{
    ViewData["Title"] = $"Деталі: {Model.Counterparty.Name}";
    Layout = "_Layout";
    bool canManage = User.IsInRole(UserRole.manager.ToString()) || User.IsInRole(UserRole.owner.ToString());
    bool isSupplier = Model.IsSupplier;
    bool isCustomer = Model.IsCustomer;
}

<h1>Контрагент: @Model.Counterparty.Name</h1>

<nav class="mt-3">
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <button class="nav-link active" id="nav-info-tab" data-bs-toggle="tab" data-bs-target="#nav-info" type="button" role="tab" aria-controls="nav-info" aria-selected="true">Інформація</button>
        <button class="nav-link" id="nav-invoices-tab" data-bs-toggle="tab" data-bs-target="#nav-invoices" type="button" role="tab" aria-controls="nav-invoices" aria-selected="false">Накладні</button>
        @if (isSupplier)
        {
            <button class="nav-link" id="nav-supplied-tab" data-bs-toggle="tab" data-bs-target="#nav-supplied" type="button" role="tab" aria-controls="nav-supplied" aria-selected="false">Товари, що постачає</button>
        }
        @if (isCustomer)
        {
            <button class="nav-link" id="nav-purchased-tab" data-bs-toggle="tab" data-bs-target="#nav-purchased" type="button" role="tab" aria-controls="nav-purchased" aria-selected="false">Товари, що закуповує</button>
        }
    </div>
</nav>

<div class="tab-content pt-3" id="nav-tabContent">

    <div class="tab-pane fade show active" id="nav-info" role="tabpanel" aria-labelledby="nav-info-tab" tabindex="0">
        <h4>Інформація</h4>
        <hr />
        <dl class="row">
            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Counterparty.Name)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Counterparty.Name)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Counterparty.PhoneNumber)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Counterparty.PhoneNumber)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Counterparty.Email)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Counterparty.Email)</dd>

            <dt class="col-sm-3">Призначені Ролі</dt>
            <dd class="col-sm-9">
                @if (Model.Counterparty.Roles != null && Model.Counterparty.Roles.Any())
                {
                    @foreach (var role in Model.Counterparty.Roles.OrderBy(r => r.Name))
                    {
                        string badgeClass = "text-bg-secondary";
                        switch (role.Name?.ToLowerInvariant())
                        {
                            case "supplier": badgeClass = "text-bg-primary"; break;
                            case "customer": badgeClass = "text-bg-success"; break;
                        }
                        <span class="badge rounded-pill @badgeClass me-1" style="font-size: 0.8em;">@role.Name</span>
                    }
                }
                else
                {
                    <span class="text-muted">Ролі не призначено.</span>
                }
            </dd>
        </dl>
        <div class="mt-3">
            <a asp-action="Edit" asp-route-name="@Model.Counterparty.Name" class="btn btn-secondary btn-sm">Редагувати Дані та Ролі</a>
        </div>
    </div>

    <div class="tab-pane fade" id="nav-invoices" role="tabpanel" aria-labelledby="nav-invoices-tab" tabindex="0">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4>Історія накладних</h4>
            @* Сюди можна додати фільтри за статусом/типом пізніше *@
            <a asp-controller="Invoice" asp-action="Create" asp-route-counterpartyName="@Model.Counterparty.Name" class="btn btn-success btn-sm">Створити накладну</a>
        </div>
        <hr />
        @if (Model.Counterparty.Invoices?.Any() ?? false)
        {
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Дата</th>
                        <th>Тип</th>
                        <th>Статус</th>
                        <th>Сума</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var invoice in Model.Counterparty.Invoices.OrderByDescending(i => i.Date).ThenByDescending(i => i.InvoiceId))
                    {
                        <tr>
                            <td>
                                    @invoice.InvoiceId
                            </td>
                            <td>@invoice.Date.ToString("dd.MM.yyyy")</td>
                            <td>@invoice.Type</td>
                            <td>@invoice.Status</td>
                            <td>@((invoice.ListEntries?.Sum(le => le.Count * le.Price) ?? 0).ToString("C2"))</td>
                            <td>
                                <a asp-controller="Invoice" asp-action="Details" asp-route-id="@invoice.InvoiceId" class="btn btn-sm btn-outline-info">Деталі</a>

                                @if (invoice.Status == InvoiceStatus.draft)
                                {
                                    <text> | </text>
                                    <a asp-controller="Invoice" asp-action="Edit" asp-route-id="@invoice.InvoiceId" class="btn btn-sm btn-outline-secondary">Редагувати</a>
                                }

                                @if (invoice.Status == InvoiceStatus.draft)
                                {
                                    <text> | </text>
                                    <a asp-controller="Invoice" asp-action="Delete" asp-route-id="@invoice.InvoiceId" class="btn btn-sm btn-outline-danger">Видалити</a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p class="text-muted">З цим контрагентом ще немає пов'язаних накладних.</p>
        }
    </div>

    @if (isSupplier)
    {
        <div class="tab-pane fade" id="nav-supplied" role="tabpanel" aria-labelledby="nav-supplied-tab" tabindex="0">
            <h4>Товари, що постачає цей контрагент</h4>
            <hr />
            @if (Model.SuppliedProducts?.Any() ?? false)
            {
                <table class="table table-sm table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>Назва товару</th>
                            <th>Од. вим.</th>
                            <th>Остання ціна</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model.SuppliedProducts)
                        {
                            <tr>
                                <td>
                                  
                                        @product.ProductName
                                </td>
                                <td>@(product.UnitCodeNavigation?.UnitName ?? "Н/Д")</td>
                                <td>@product.LastPrice.ToString("C2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted">Немає даних про товари, що постачалися цим контрагентом.</p>
            }
        </div>
    }

    @if (isCustomer)
    {
        <div class="tab-pane fade" id="nav-purchased" role="tabpanel" aria-labelledby="nav-purchased-tab" tabindex="0">
            <h4>Товари, що закуповує цей контрагент</h4>
            <hr />
            @if (Model.PurchasedProducts?.Any() ?? false)
            {
                <table class="table table-sm table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>Назва товару</th>
                            <th>Од. вим.</th>
                            <th>Остання ціна</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model.PurchasedProducts)
                        {
                            <tr>
                                <td>
                                        @product.ProductName
                                </td>
                                <td>@(product.UnitCodeNavigation?.UnitName ?? "Н/Д")</td>
                                <td>@product.LastPrice.ToString("C2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted">Немає даних про товари, що закуповувалися цим контрагентом.</p>
            }
        </div>
    }

</div>


<div class="mt-4">
    <a asp-controller="Counterparty" asp-action="Index" class="btn btn-outline-secondary">Назад до списку контрагентів</a>
</div>

@section Scripts {
<script>
             $(document).ready(function(){
                 var hash = window.location.hash;
                 if (hash) {
                     $('.nav-tabs button[data-bs-target="' + hash + '"]').tab('show');
                 }
                 $('.nav-tabs button').on('click', function (e) {
                     if (history.pushState) {
                         history.pushState(null, null, this.getAttribute('data-bs-target'));
                     } else {
                         location.hash = this.getAttribute('data-bs-target');
                     }
                 });
             });
         </script>
 }